# vim: set syntax=sh ts=8 sw=8 sts=0 noexpandtab :
#
# Additional repos for nrgaway
#
# Contains overrides specific to each branch as well as providing proper
# access to those with no ssh access to my repos

# NOTES:
# In a fresh qubes-builder vm, need these files to accept nrgaway repos
# - override.conf - repo defs + nrgaway-keyring
# - .setup.data.nrgaway -> over-write existing .setup.data (to verify my keys)
# - nrgaway-qubes-signing-key.asc
# 
# Still need to run 'make nrgaway-keyring' though; maybe add into setup
#
#
# for r2/r3 template branches
#

DEBUG = 0
VERBOSE = 2
NO_SIGN = 1
#NO_CHECK = 

SNAPSHOT := 0
SYSTEMD_NSPAWN_ENABLE := 0

GITHUB_PREFIX = $(word $(SSH_ACCESS), http://github.com/nrgaway git@github.com:nrgaway)
RELEASE_INDEX = $(shell echo "$(RELEASE)-1" | bc)
TRACK_REPO :=

# Personal alias preferences
[==- 'Personal Alias Preferences' =============================================
TEMPLATE_LABEL := $(patsubst 	jessie+gnome+flash:debian-8-x64-gnome, \
				jessie+gnome+flash:debian-jessie, $(TEMPLATE_LABEL))
TEMPLATE_LABEL := $(patsubst 	wheezy+whonix-gateway:whonix-gateway-experimental, \
				wheezy+whonix-gateway:whonix-gateway, $(TEMPLATE_LABEL))
TEMPLATE_LABEL := $(patsubst 	wheezy+whonix-workstation:whonix-workstation-experimental, \
				wheezy+whonix-workstation:whonix-workstation, $(TEMPLATE_LABEL))

TEMPLATE_LABEL := $(patsubst 	trusty+desktop+flash:qubuntu-trusty-x64-desktop, \
				trusty+desktop+flash:qubuntu-trusty-desktop, $(TEMPLATE_LABEL))
TEMPLATE_LABEL := $(patsubst 	utopic+desktop+flash:qubuntu-utopic-x64-desktop, \
				utopic+desktop+flash:qubuntu-utopic-desktop, $(TEMPLATE_LABEL))
TEMPLATE_LABEL := $(patsubst 	vivid+desktop+flash:qubuntu-vivid-x64-desktop, \
				vivid+desktop+flash:qubuntu-vivid-desktop, $(TEMPLATE_LABEL))
[===============================================================================

# Track upstream 
# git branch -u marmarek/master r3-templates
#
# Debian Package Hardening
# https://wiki.debian.org/Hardening
#
#INCREMENT_DEVEL_VERSIONS=1

[==- 'qubes-tools' =============================================================
[==- Personal development tools, research, notes, etc
[===============================================================================
COMPONENTS += qubes-tools
GIT_URL_qubes_tools = $(GITHUB_PREFIX)/qubes-tools.git
BRANCH_qubes_tools = $(word $(RELEASE_INDEX), master master)


[==- 'qubes-template-salt' =====================================================
[==- Development salt states, modules, etc
[===============================================================================
COMPONENTS += qubes-template-salt
GIT_URL_qubes_template_salt = $(GITHUB_PREFIX)/qubes-template-salt.git
BRANCH_qubes_template_salt = $(word $(RELEASE_INDEX), develop develop)


[==- 'qubes-whonix' ============================================================
[==- defaults: [R2:9.6.2, R3:9.6.2]
[===============================================================================
#GIT_URL_qubes_whonix = $(GITHUB_PREFIX)/qubes-whonix.git
#BRANCH_qubes_whonix = $(word $(RELEASE_INDEX), 9.6.2 9.6.2)


[==- 'Whonix' ==================================================================
[==- defaults: [R2:9.6, R3:9.6]
[===============================================================================
#GIT_URL_Whonix = $(GITHUB_PREFIX)/Whonix.git
#BRANCH_Whonix = $(word $(RELEASE_INDEX), 9.6 9.6)


[==- 'whonix-setup-wizard' =====================================================
[==- defaults: [R2:0.5-1, R3:0.5-1]
[===============================================================================
#GIT_URL_whonix_setup_wizard = https://github.com/Whonix/whonix-setup-wizard.git
#BRANCH_whonix_setup_wizard = $(word $(RELEASE_INDEX), 0.5-1 0.5-1)


[==- 'python-guimessages' ======================================================
[==- defaults: [R2:0.3-1, R3:0.3-1]
[===============================================================================
#GIT_URL_python_guimessages = https://github.com/Whonix/python-guimessages.git
#BRANCH_python_guimessages = $(word $(RELEASE_INDEX), 0.3-1 0.3-1)


[==- 'qubes-builder' ===========================================================
[==- defaults: [R2:master, R3:master]
[===============================================================================
GIT_URL_qubes_builder = $(GITHUB_PREFIX)/qubes-builder.git
BRANCH_qubes_builder = $(word $(RELEASE_INDEX), master master)
TRACK_REPO += qubes-builder:r3-templates-no-binaries:marmarek:master
TRACK_REPO += qubes-builder:master:marmarek:master


[==- 'qubes-core-admin' ========================================================
[==- defaults: [R2:release2, R3:master] ['core3']
[===============================================================================
#GIT_URL_qubes_core_admin = $(GITHUB_PREFIX)/qubes-core-admin.git
#BRANCH_qubes_core_admin = $(word $(RELEASE_INDEX), release2 core3)
#TRACK_REPO += qubes-core-admin:core3:woju:core3


[==- 'qubes-linux-template-builder' ============================================
[==- defaults: [R2:master, R3:master]
[==- branches: debian, ubuntu, fc21, whonix9.2, whonix9.4, whonix
[===============================================================================
GIT_URL_qubes_linux_template_builder = $(GITHUB_PREFIX)/qubes-linux-template-builder.git
BRANCH_qubes_linux_template_builder = $(word $(RELEASE_INDEX), templates-no-binaries templates-no-binaries)
TRACK_REPO += qubes-linux-template-builder:templates-no-binaries:marmarek:master


[==- 'qubes-core-agent-linux' ==================================================
[==- defaults: [R2:release2, R3:master]
[===============================================================================
GIT_URL_qubes_core_agent_linux = $(GITHUB_PREFIX)/qubes-core-agent-linux.git
BRANCH_qubes_core_agent_linux = $(word $(RELEASE_INDEX), release2 r3-templates)
TRACK_REPO += qubes-core-agent-linux:r3-templates:marmarek:master


[==- 'qubes-gui-agent-linux'====================================================
[==- defaults: [R2:release2, R3:master]
[==- git diff debian..upstream/release2
[==- '*** upstream still missing appvm-scripts/usrbin/qubes-session commit ***'
[===============================================================================
GIT_URL_qubes_gui_agent_linux = $(GITHUB_PREFIX)/qubes-gui-agent-linux.git
BRANCH_qubes_gui_agent_linux = $(word $(RELEASE_INDEX), r2-templates r3-templates)
TRACK_REPO += qubes-gui-agent-linux:r3-templates:marmarek:master


[==- 'qubes-app-linux-pdf-converter' ===========================================
[==- defaults: [R2:master, R3:master]
[==- '*** (for fc21) ***'
[===============================================================================
GIT_URL_qubes_app_linux_pdf_converter = $(GITHUB_PREFIX)/qubes-app-linux-pdf-converter.git
BRANCH_qubes_app_linux_pdf_converter = $(word $(RELEASE_INDEX), fc21 fc21)
TRACK_REPO += qubes-app-linux-pdf-converter:fc21:marmarek:master


[==- 'qubes-core-vchan-xen' ====================================================
[==- defaults: [R2:release2, R3:master]
[==- '*** (for xubuntu) ***'
[===============================================================================
GIT_URL_qubes_core_vchan_xen = $(GITHUB_PREFIX)/qubes-core-vchan-xen.git
BRANCH_qubes_core_vchan_xen = $(word $(RELEASE_INDEX), r2-templates r3-templates)
TRACK_REPO += qubes-core-vchan-xen:r3-templates:marmarek:master


[==- 'qubes-vmm-xen' ===========================================================
[==- defaults: [R2:release2, R3:xen-4.4]
[===============================================================================
GIT_URL_qubes_vmm_xen = $(GITHUB_PREFIX)/qubes-vmm-xen.git
BRANCH_qubes_vmm_xen = $(word $(RELEASE_INDEX), r2-templates r3-templates)
TRACK_REPO += qubes-vmm-xen:r3-templates:marmarek:xen-4.4
#BRANCH_vmm_xen = $(word $(RELEASE_INDEX), r2-templates xen-4.3-vgt)


[==- 'qubes-core-qubesdb' ======================================================
[==- defaults: [R2:n/a, R3:master]
[===============================================================================
GIT_URL_qubes_core_qubesdb = $(GITHUB_PREFIX)/qubes-core-qubesdb.git
BRANCH_qubes_core_qubesdb = $(word $(RELEASE_INDEX), r3-templates r3-templates)
TRACK_REPO += qubes-core-qubesdb:r3-templates:marmarek:master


[==- 'qubes-linux-utils' =======================================================
[==- defaults: [R2:release2, R3:master]
[===============================================================================
GIT_URL_qubes_linux_utils = $(GITHUB_PREFIX)/qubes-linux-utils.git
BRANCH_qubes_linux_utils = $(word $(RELEASE_INDEX), release2 r3-templates)
TRACK_REPO += qubes-linux-utils:r3-templates:marmarek:master


[==- 'qubes-linux-kernel' ======================================================
[==- defaults: [R2:stable-3.12, R3:stable-3.12]
[===============================================================================
ifneq ($(TEMPLATE_ONLY), 1)
  # Could just comment this out to receive from upstream
  GIT_URL_qubes_linux_kernel = $(GITHUB_PREFIX)/qubes-linux-kernel.git
  BRANCH_qubes_linux_kernel = stable-3.12

  #COMPONENTS += qubes-linux-kernel-3_17
  #GIT_URL_qubes_linux_kernel_3_17 = $(GITHUB_PREFIX)/qubes-linux-kernel.git
  #BRANCH_qubes_linux_kernel_3_17 = devel-3.17

  #COMPONENTS += qubes-linux-kernel-3_14
  #GIT_URL_qubes_linux_kernel_3_14 = $(GITHUB_PREFIX)/qubes-linux-kernel.git
  #BRANCH_qubes_linux_kernel_3_14 = devel-3.14+vgt

  COMPONENTS += qubes-linux-kernel-3_18
  GIT_URL_qubes_linux_kernel_3_18 = $(GITHUB_PREFIX)/qubes-linux-kernel.git
  BRANCH_qubes_linux_kernel_3_18 = devel-3.18+vgt

  #
  # XXX: TEMP: Just to test building of 3.18 branch; make 3.18 deafult
  #
  #GIT_URL_qubes_linux_kernel = $(GITHUB_PREFIX)/qubes-linux-kernel.git
  #BRANCH_qubes_linux_kernel = devel-3.18
endif


.PHONY: remote
remote:
	@- $(foreach REPO, $(TRACK_REPO), \
	     $(eval repo = $(word 1,$(subst :, ,$(REPO)))) \
	     $(eval local_branch = $(word 2,$(subst :, ,$(REPO)))) \
	     $(eval prefix = $(word 3,$(subst :, ,$(REPO)))) \
	     $(eval remote_branch = $(word 4,$(subst :, ,$(REPO)))) \
	     \
	     pushd $(PWD)/qubes-src/$(repo); \
	     echo "Creating remote for repo: $(repo)..."; \
	     git $(prefix) | true; \
	     git fetch --all; \
	     git branch -u $(prefix)/$(remote_branch) $(local_branch) | true; \
	     popd; \
	   )

[===============================================================================
[==-                   'C U S T O M   T A R G E T S'
[===============================================================================
.PHONY: get-sources
get-sources:: nrgaway-keyring

.PHONY: nrgaway-keyring
nrgaway-keyring::
	# nrgaway Keyring
	# calling verify-git-tag.sh will create keyrings dir and add developer keys
	@dir="$$(readlink -m .)"; \
	KEYRING_DIR_GIT="$$dir/keyrings/git"; \
	export GNUPGHOME="$$(readlink -m $$KEYRING_DIR_GIT)"; \
	./verify-git-tag.sh; \
	echo 'E0E32283FDCAC1A510078F271BB9B1FB5A4C6DAD:6:' | gpg --import-ownertrust; \
	gpg --import nrgaway-qubes-signing-key.asc; \
	gpg --list-keys; \
	touch "$$GNUPGHOME/pubring.gpg"

about::
	@echo "override.conf"
